//
// RUN: gluc %s --print-gil-after-pass=simplify-copy-to-drop | FileCheck %s
// RUN: gluc %s -o %t && %t | FileCheck %s --check-prefix=EXEC
//
// Test that load [copy] + load [take] + drop is simplified to just load [take]
// This avoids calling drop twice when returning a non-trivial value

struct NonTrivial {
    value: Int32
}

func drop(x: *NonTrivial) {
    std::print("Dropping NonTrivial\n");
}

// CHECK-LABEL: gil @testNonTrivial
func testNonTrivial() -> NonTrivial {
    let n: NonTrivial = { 42 };
    return n;
// After optimization: load [copy] becomes load [take], and the drop is removed
// CHECK: load [take] %{{[0-9]+}} : $*NonTrivial
// CHECK-NOT: drop %{{[0-9]+}} : $NonTrivial
// CHECK: return
}

func main() {
    std::print("before");
    let n = testNonTrivial();
    std::print("after");
}

// Verify drop is called exactly once (only in main when it goes out of scope)
// The print before/after ensures that drop is NOT called during testNonTrivial()
// (because the optimization transformed copy+drop into take)
// EXEC: before
// EXEC-NEXT: after
// EXEC-NEXT: Dropping NonTrivial

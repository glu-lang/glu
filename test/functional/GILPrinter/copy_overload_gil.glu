//
// RUN: gluc %s --print-gil | FileCheck -v %s --check-prefix=CHECK-GIL
//

struct Counter {
    value: Int
}

// Define a copy function that modifies the value
func copy(c: *Counter) -> Counter {
    var newCounter: Counter;
    newCounter.value = c.*.value + 1;
    return newCounter;
}

// CHECK-GIL-LABEL: gil @copy : $(*Counter) -> Counter {
// CHECK-GIL: %[[PTR:[0-9]+]] = load [trivial] %{{[0-9]+}} : $**Counter
// CHECK-GIL: struct_field_ptr %[[PTR]] : $*Counter, #Counter::value
// CHECK-GIL: load [trivial] %{{[0-9]+}} : $*Int32
// CHECK-GIL-NOT: struct_extract

// CHECK-GIL-LABEL: gil @testCopy : $(Counter) -> Int32 {
// CHECK-GIL: load [copy] %{{[0-9]+}} : $*Counter
// CHECK-GIL: struct_field_ptr %{{[0-9]+}} : $*Counter, #Counter::value
// CHECK-GIL-NOT: struct_extract

func testCopy(c: Counter) -> Int {
    var c2: Counter = c; // This should call the copy function
    return c2.value;
}

func main() -> Int {
    var c1: Counter;
    c1.value = 10;
    
    var result: Int = testCopy(c1);
    
    return result;
}

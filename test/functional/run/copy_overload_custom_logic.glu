//
// RUN: gluc %s --print-gil | FileCheck --check-prefix=GIL %s
// RUN: gluc %s -o %t && %t | FileCheck %s
//

struct Node {
    data: Int
}

// Custom copy that doubles the data
func copy(n: *Node) -> Node {
// GIL-LABEL: gil @copy : $(*Node) -> Node {
// GIL: %[[PTRADDR:[0-9]+]] = load [trivial] %{{[0-9]+}} : $**Node
// GIL: %[[FIELD_PTR:[0-9]+]] = struct_field_ptr %[[PTRADDR]] : $*Node, #Node::data
// GIL: load [trivial] %[[FIELD_PTR]] : $*Int32
// GIL-NOT: load [copy] %[[PTRADDR]] : $*Node
// GIL-NOT: struct_extract %
// GIL: return %{{[0-9]+}} : $Node
    var newNode: Node = { n.*.data * 2 };
    return newNode;
}

func main() -> Int {
    var n1: Node = {5};

    var n2: Node = n1;

    // If copy worked correctly, result should be 10 (doubled)
    std::assert(n1.data == 5);
    std::assert(n2.data == 10);

    // CHECK: SUCCESS: Copy function works correctly!
    std::print("SUCCESS: Copy function works correctly!");
    return 0;
}
